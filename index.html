<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Video Library</title>
<link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f0f0f; color: #f0f0f0; margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; }
.header { background: #1a1a1a; box-shadow: 0 2px 10px rgba(0,0,0,0.5); padding: 1rem 2rem; text-align: center; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
.header h1 { font-weight: 600; color: #e0e0e0; margin: 0; font-size: 1.6rem; cursor: pointer; flex: 1; text-align: center; }
.admin-btn { background: #4a90e2; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
.admin-btn:hover { background: #357abd; }
.admin-btn.logout { background: #dc3545; }
.admin-btn.logout:hover { background: #c82333; }
.user-info { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #888; }
.filters { padding: 1rem 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; background: #151515; border-bottom: 1px solid #333; }
.filters select, .filters input { padding: 0.5rem 0.8rem; border-radius: 6px; border: 1px solid #444; background: #222; color: #fff; font-size: 0.95rem; min-width: 140px; }
.filters select:focus, .filters input:focus { outline: none; border-color: #4a90e2; }
.video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; padding: 1.5rem 2rem; }
.video-card { background: #1a1a1a; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; border: 1px solid #333; }
.video-card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.4); }
.card-thumb { width: 100%; height: 160px; background: #222; display: flex; align-items: center; justify-content: center; position: relative; }
.card-thumb img { width: 100%; height: 100%; object-fit: cover; display: none; }
.card-thumb .placeholder { color: #666; font-size: 2.5rem; }
.card-thumb img.loaded { display: block; }
.card-content { padding: 1rem; }
.card-title { font-size: 0.95rem; font-weight: 500; margin-bottom: 0.4rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-overflow: ellipsis; }
.card-meta { font-size: 0.8rem; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.protected-badge { position: absolute; top: 8px; right: 8px; background: #d97706; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
.pagination { padding: 1rem 2rem; display: flex; justify-content: center; gap: 0.5rem; }
.pagination button { padding: 0.4rem 0.8rem; background: #2a2a2a; border: 1px solid #444; color: #ccc; border-radius: 4px; cursor: pointer; }
.pagination button:hover:not(:disabled) { background: #333; color: #fff; }
.pagination button.active { background: #4a90e2; color: white; border-color: #4a90e2; }
.pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
#videoPopupModal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.92); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; padding: 20px; box-sizing: border-box; }
#popupControls { display: flex; align-items: center; justify-content: space-between; width: 90%; max-width: 900px; opacity: 0; transition: opacity 0.25s ease; margin-bottom: 12px; }
#videoPopupModal:hover #popupControls { opacity: 1; }
#popupTitle { color: white; font-size: 1.2rem; text-align: center; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 16px; }
#backToListBtn, #closePopup { background: rgba(255,255,255,0.9); color: #000; border: none; width: 36px; height: 36px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 3001; }
#popupVideoFrame { width: 90%; max-width: 900px; height: 540px; border: none; border-radius: 8px; }
#passwordModal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.7); z-index: 2000; justify-content: center; align-items: center; }
#passwordModal .modal-content { background: #1a1a1a; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 6px 20px rgba(0,0,0,0.5); border: 1px solid #444; color: #f0f0f0; }
#passwordError { display: none; color: #f87171; font-size: 0.85rem; margin-top: 0.5rem; }
#addVideoModal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); z-index: 4000; justify-content: center; align-items: center; }
#addVideoModal .modal-content { background: #1a1a1a; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 6px 20px rgba(0,0,0,0.5); border: 1px solid #444; color: #f0f0f0; max-height: 90vh; overflow-y: auto; }
#addVideoModal .form-label { color: #ccc; font-size: 0.9rem; }
#addVideoModal .form-control, #addVideoModal .form-select { background: #222; border: 1px solid #444; color: #fff; }
#addVideoModal .form-control:focus, #addVideoModal .form-select:focus { background: #222; color: #fff; border-color: #4a90e2; box-shadow: none; }
#addVideoStatus { margin-top: 1rem; font-size: 0.9rem; }
.status-success { color: #4ade80; }
.status-error { color: #f87171; }
#authModal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); z-index: 5000; justify-content: center; align-items: center; }
#authModal .modal-content { background: #1a1a1a; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 6px 20px rgba(0,0,0,0.5); border: 1px solid #444; color: #f0f0f0; }
#authModal .form-label { color: #ccc; font-size: 0.9rem; }
#authModal .form-control { background: #222; border: 1px solid #444; color: #fff; }
#authModal .form-control:focus { background: #222; color: #fff; border-color: #4a90e2; box-shadow: none; }
#authError { display: none; color: #f87171; font-size: 0.85rem; margin-top: 0.5rem; }
@media (max-width: 768px) { .header { flex-direction: column; gap: 1rem; } .filters { flex-direction: column; align-items: stretch; } .video-grid { grid-template-columns: 1fr; padding: 1rem; } .filters select, .filters input { min-width: auto; width: 100%; } }
</style>
</head>
<body>
<div class="header">
<div style="display: flex; align-items: center; gap: 1rem;">
<button id="adminBtn" class="admin-btn" style="display: none;"><i class="fas fa-plus"></i> Add Video</button>
<button id="authBtn" class="admin-btn"><i class="fas fa-sign-in-alt"></i> Admin Login</button>
</div>
<h1 id="headerTitle"><i class="fa-solid fa-video"></i>&nbsp;&nbsp;&nbsp;Video Library</h1>
<div class="user-info" id="userInfo" style="display: none;"><i class="fas fa-user-circle"></i><span id="userEmail"></span></div>
</div>
<div class="filters">
<select id="categoryFilter"><option value="">All Categories</option></select>
<select id="subcategoryFilter"><option value="">All Subcategories</option></select>
<select id="topicFilter"><option value="">All Topics</option></select>
<input type="text" id="searchBox" placeholder="Search videos..." autocomplete="off" style="flex:1; max-width:300px;">
</div>
<div class="video-grid" id="videoGrid"><div style="grid-column:1/-1; text-align:center; padding:2rem; color:#666;">Loading library...</div></div>
<div class="pagination" id="pagination"></div>

<!-- Popup Video Modal -->
<div id="videoPopupModal">
<div id="popupControls">
<button id="backToListBtn" title="Back to list"><i class="fas fa-arrow-left"></i></button>
<div id="popupTitle"></div>
<button id="closePopup" title="Close">×</button>
</div>
<iframe id="popupVideoFrame" allowfullscreen></iframe>
</div>

<!-- Password Modal -->
<div id="passwordModal">
<div class="modal-content">
<h5 class="mb-3"><i class="fas fa-lock me-2"></i>Enter Password</h5>
<input type="password" id="videoPassword" class="form-control" placeholder="Password" autocomplete="off">
<p id="passwordError">Incorrect password. Please try again.</p>
<div class="d-flex justify-content-between mt-3">
<button id="cancelPassword" class="btn btn-secondary btn-sm">Cancel</button>
<button id="submitPassword" class="btn btn-primary btn-sm">Unlock Video</button>
</div>
</div>
</div>

<!-- Add Video Modal -->
<div id="addVideoModal">
    <div class="modal-content">
        <h5 class="mb-3"><i class="fas fa-upload me-2"></i>Add New Video</h5>
        <form id="addVideoForm">
            <div class="mb-2"><label class="form-label">Title</label><input type="text" id="newTitle" class="form-control" required></div>
            <div class="mb-2"><label class="form-label">Type</label>
                <select id="newType" class="form-select" required>
                    <option value="youtube">YouTube</option><option value="drive">Google Drive</option><option value="pdf">PDF</option><option value="youtube-playlist">YouTube Playlist</option>
                </select>
            </div>
            <div class="mb-2"><label class="form-label">ID / URL</label><input type="text" id="newId" class="form-control" placeholder="Drive ID or YouTube URL" required><small class="text-muted" style="font-size:0.75rem">For YouTube, paste full URL. For Drive, paste File ID.</small></div>
            <div class="mb-2"><label class="form-label">Category</label><input type="text" id="newCategory" class="form-control" list="categoryList" required><datalist id="categoryList"></datalist></div>
            <div class="mb-2"><label class="form-label">Subcategory</label><input type="text" id="newSubcategory" class="form-control" list="subcategoryList"><datalist id="subcategoryList"></datalist></div>
            <div class="mb-2"><label class="form-label">Topic</label><input type="text" id="newTopic" class="form-control" list="topicList"><datalist id="topicList"></datalist></div>
            <div class="mb-3 form-check"><input type="checkbox" class="form-check-input" id="newProtected"><label class="form-check-label">Password Protected</label></div>
            <div id="addVideoStatus"></div>
            <div class="d-flex justify-content-between mt-3">
                <button type="button" id="cancelAddVideo" class="btn btn-secondary btn-sm">Cancel</button>
                <button type="submit" class="btn btn-primary btn-sm">Save Video</button>
            </div>
        </form>
    </div>
</div>

<!-- Auth Modal -->
<div id="authModal">
    <div class="modal-content">
        <h5 class="mb-3" id="authTitle"><i class="fas fa-sign-in-alt me-2"></i>Admin Login</h5>
        <form id="authForm">
            <div class="mb-2"><label class="form-label">Email</label><input type="email" id="authEmail" class="form-control" required></div>
            <div class="mb-2"><label class="form-label">Password</label><input type="password" id="authPassword" class="form-control" required></div>
            <p id="authError"></p>
            <div class="d-flex justify-content-between mt-3">
                <button type="button" id="cancelAuth" class="btn btn-secondary btn-sm">Cancel</button>
                <button type="submit" class="btn btn-primary btn-sm" id="authSubmitBtn">Login</button>
            </div>
        </form>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyB82MwSrGp35eS2ZXBsBlhie6EL6s-5HK0",
  authDomain: "videolibrary-4709d.firebaseapp.com",
  projectId: "videolibrary-4709d",
  storageBucket: "videolibrary-4709d.firebasestorage.app",
  messagingSenderId: "752788156798",
  appId: "1:752788156798:web:df6dc050abc7de4150432f"
};

let db, auth;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
} catch (e) {
    console.error("Firebase init error:", e);
    document.getElementById('videoGrid').innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#f87171;">Firebase Config Missing.</div>`;
}

const VIDEOS_PER_PAGE = 100;
let allVideos = [];
let filteredVideos = [];
let currentPage = 1;
const VIDEO_PASSWORD = "Animator";
let currentUser = null;

// DOM Elements
const categoryFilter = document.getElementById('categoryFilter');
const subcategoryFilter = document.getElementById('subcategoryFilter');
const topicFilter = document.getElementById('topicFilter');
const searchBox = document.getElementById('searchBox');
const videoGrid = document.getElementById('videoGrid');
const paginationEl = document.getElementById('pagination');
const popupModal = document.getElementById('videoPopupModal');
const popupFrame = document.getElementById('popupVideoFrame');
const popupTitle = document.getElementById('popupTitle');
const closePopup = document.getElementById('closePopup');
const backToListBtn = document.getElementById('backToListBtn');
const passwordModal = document.getElementById('passwordModal');
const videoPassword = document.getElementById('videoPassword');
const submitPassword = document.getElementById('submitPassword');
const cancelPassword = document.getElementById('cancelPassword');
const passwordError = document.getElementById('passwordError');
const headerTitle = document.getElementById('headerTitle');
const adminBtn = document.getElementById('adminBtn');
const authBtn = document.getElementById('authBtn');
const userInfo = document.getElementById('userInfo');
const userEmail = document.getElementById('userEmail');
const addVideoModal = document.getElementById('addVideoModal');
const addVideoForm = document.getElementById('addVideoForm');
const cancelAddVideo = document.getElementById('cancelAddVideo');
const addVideoStatus = document.getElementById('addVideoStatus');
const categoryList = document.getElementById('categoryList');
const subcategoryList = document.getElementById('subcategoryList');
const topicList = document.getElementById('topicList');
const authModal = document.getElementById('authModal');
const authForm = document.getElementById('authForm');
const authEmail = document.getElementById('authEmail');
const authPassword = document.getElementById('authPassword');
const authError = document.getElementById('authError');
const authSubmitBtn = document.getElementById('authSubmitBtn');
const cancelAuth = document.getElementById('cancelAuth');

let currentVideo = null;

// Auth State
if (auth) {
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            adminBtn.style.display = 'flex';
            authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
            authBtn.classList.add('logout');
            userInfo.style.display = 'flex';
            userEmail.textContent = user.email;
        } else {
            adminBtn.style.display = 'none';
            authBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Admin Login';
            authBtn.classList.remove('logout');
            userInfo.style.display = 'none';
        }
    });
}

// Data Sync from Firebase
if (db) {
    const q = query(collection(db, "videos"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        allVideos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log(`Loaded ${allVideos.length} videos from Firebase`);
        updateDataLists();
        populateFilters();
        applyFilters(); 
    }, (error) => {
        console.error("Error fetching videos:", error);
        videoGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#f87171;">Error loading videos.</div>`;
    });
}

// Helpers
function getYouTubeId(url) {
    if(!url) return null;
    const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.trim().match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}
function getThumbnailUrl(item) {
    if (item.type === "youtube") {
        const id = getYouTubeId(item.url || item.id);
        return id ? `https://img.youtube.com/vi/${id}/mqdefault.jpg` : null;
    } else if (item.type === "youtube-playlist") {
        if (item.firstVideoId) return `https://img.youtube.com/vi/${item.firstVideoId}/mqdefault.jpg`;
        return null;
    } else if ((item.type === "drive" || item.type === "pdf") && item.id) {
        return `https://drive.google.com/thumbnail?id=${item.id}&sz=w640`;
    }
    return null;
}
function getEmbedUrl(item) {
    if (item.type === "youtube") {
        const id = getYouTubeId(item.url || item.id);
        return id ? `https://www.youtube.com/embed/${id}?autoplay=1` : null;
    } else if (item.type === "youtube-playlist") {
        return `https://www.youtube.com/embed/videoseries?list=${item.id}&autoplay=1`;
    } else if ((item.type === "drive" || item.type === "pdf") && item.id) {
        return `https://drive.google.com/file/d/${item.id}/preview`;
    }
    return null;
}

// Update datalists for admin form
function updateDataLists() {
    const cats = [...new Set(allVideos.map(v => v.category).filter(Boolean))].sort();
    const subs = [...new Set(allVideos.map(v => v.subcategory).filter(Boolean))].sort();
    const tops = [...new Set(allVideos.map(v => v.topic).filter(Boolean))].sort();
    categoryList.innerHTML = cats.map(c => `<option value="${c}">`).join('');
    subcategoryList.innerHTML = subs.map(s => `<option value="${s}">`).join('');
    topicList.innerHTML = tops.map(t => `<option value="${t}">`).join('');
}

// ✅ FIXED: Populate category filter dropdown
function populateFilters() {
    const cats = [...new Set(allVideos.map(v => (v.category || "Uncategorized").trim()))].sort();
    
    const currentValue = categoryFilter.value;
    categoryFilter.innerHTML = '<option value="">All Categories</option>';
    
    cats.forEach(cat => {
        if (cat && cat.trim()) {
            const opt = document.createElement('option');
            opt.value = cat.trim();
            opt.textContent = cat.trim();
            categoryFilter.appendChild(opt);
        }
    });
    
    // Restore selection if still valid
    if (currentValue && cats.includes(currentValue)) {
        categoryFilter.value = currentValue;
    }
    
    updateSubcategories();
}

// ✅ FIXED: Update subcategories based on selected category
function updateSubcategories() {
    const cat = categoryFilter.value.trim();
    const currentSubValue = subcategoryFilter.value;
    
    subcategoryFilter.innerHTML = '<option value="">All Subcategories</option>';
    topicFilter.innerHTML = '<option value="">All Topics</option>';
    
    if (!cat) {
        subcategoryFilter.value = '';
        topicFilter.value = '';
        return;
    }
    
    const subs = [...new Set(
        allVideos
            .filter(v => (v.category || "Uncategorized").trim() === cat)
            .map(v => (v.subcategory || "").trim())
            .filter(Boolean)
    )].sort();
    
    subs.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        subcategoryFilter.appendChild(opt);
    });
    
    // Restore selection if still valid
    if (currentSubValue && subs.includes(currentSubValue)) {
        subcategoryFilter.value = currentSubValue;
    } else {
        subcategoryFilter.value = '';
    }
    
    updateTopics();
}

// ✅ FIXED: Update topics based on selected category and subcategory
function updateTopics() {
    const cat = categoryFilter.value.trim();
    const sub = subcategoryFilter.value.trim();
    const currentTopicValue = topicFilter.value;
    
    topicFilter.innerHTML = '<option value="">All Topics</option>';
    
    if (!cat || !sub) {
        topicFilter.value = '';
        return;
    }
    
    const topics = [...new Set(
        allVideos
            .filter(v => (v.category || "Uncategorized").trim() === cat && (v.subcategory || "").trim() === sub)
            .map(v => (v.topic || "").trim())
            .filter(Boolean)
    )].sort();
    
    topics.forEach(top => {
        const opt = document.createElement('option');
        opt.value = top;
        opt.textContent = top;
        topicFilter.appendChild(opt);
    });
    
    // Restore selection if still valid
    if (currentTopicValue && topics.includes(currentTopicValue)) {
        topicFilter.value = currentTopicValue;
    } else {
        topicFilter.value = '';
    }
}

function createVideoCard(video) {
    const card = document.createElement('div');
    card.className = 'video-card';
    const thumbUrl = getThumbnailUrl(video);
    const meta = [video.category || '', video.subcategory, video.topic].filter(Boolean).join(' • ');
    let thumbHtml = '';
    if (thumbUrl) {
        thumbHtml = `<img src="${thumbUrl}" alt="Thumbnail">`;
    } else {
        let iconClass = "fa-video";
        if (video.type === "pdf") iconClass = "fa-file-pdf";
        else if (video.type === "youtube") iconClass = "fa-youtube";
        else if (video.type === "youtube-playlist") iconClass = "fa-list";
        else iconClass = "fa-google-drive";
        thumbHtml = `<div class="placeholder"><i class="fas ${iconClass}"></i></div>`;
    }
    card.innerHTML = `
    <div class="card-thumb">
    ${thumbHtml}
    ${video.protected ? `<div class="protected-badge"><i class="fas fa-lock"></i></div>` : ''}
    ${currentUser ? `<button class="delete-btn" style="position:absolute;top:8px;left:8px;background:#dc3545;color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:0.7rem;"><i class="fas fa-trash"></i></button>` : ''}
    </div>
    <div class="card-content">
    <div class="card-title">${video.title}</div>
    <div class="card-meta">${meta}</div>
    </div>`;
    if (currentUser) {
        const deleteBtn = card.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm(`Delete "${video.title}"?`)) {
                try { await deleteDoc(doc(db, "videos", video.id)); } catch (error) { console.error(error); }
            }
        });
    }
    if (thumbUrl) {
        const img = card.querySelector('img');
        img.onload = () => img.classList.add('loaded');
        img.onerror = () => { img.style.display = 'none'; card.querySelector('.placeholder').style.display = 'flex'; };
    }
    card.addEventListener('click', () => openVideo(video));
    return card;
}

function applyFilters() {
    let list = [...allVideos];
    const cat = categoryFilter.value.trim();
    const sub = subcategoryFilter.value.trim();
    const top = topicFilter.value.trim();
    const query = searchBox.value.trim().toLowerCase();
    
    if (cat) list = list.filter(v => (v.category || "Uncategorized").trim() === cat);
    if (sub) list = list.filter(v => (v.subcategory || "").trim() === sub);
    if (top) list = list.filter(v => (v.topic || "").trim() === top);
    if (query) {
        list = list.filter(v => 
            v.title.toLowerCase().includes(query) || 
            (v.category && v.category.toLowerCase().includes(query)) || 
            (v.subcategory && v.subcategory.toLowerCase().includes(query)) || 
            (v.topic && v.topic.toLowerCase().includes(query))
        );
    }
    filteredVideos = list;
    currentPage = 1;
    renderVideos();
}

function renderVideos() {
    if (!allVideos.length) {
        videoGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#666;">No videos found in database.</div>`;
        paginationEl.innerHTML = '';
        return;
    }
    const total = filteredVideos.length;
    const totalPages = Math.max(1, Math.ceil(total / VIDEOS_PER_PAGE));
    currentPage = Math.min(currentPage, totalPages);
    const start = (currentPage - 1) * VIDEOS_PER_PAGE;
    const pageVideos = filteredVideos.slice(start, start + VIDEOS_PER_PAGE);
    videoGrid.innerHTML = '';
    if (pageVideos.length === 0) {
        videoGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#666;">No videos found.</div>`;
    } else {
        pageVideos.forEach(v => videoGrid.appendChild(createVideoCard(v)));
    }
    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    paginationEl.innerHTML = '';
    if (totalPages <= 1) return;
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    if (endPage - startPage + 1 < maxVisible) startPage = Math.max(1, endPage - maxVisible + 1);
    const prev = document.createElement('button');
    prev.textContent = '«';
    prev.disabled = currentPage === 1;
    prev.onclick = () => { if (currentPage > 1) { currentPage--; renderVideos(); } };
    paginationEl.appendChild(prev);
    for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => { currentPage = i; renderVideos(); };
        paginationEl.appendChild(btn);
    }
    const next = document.createElement('button');
    next.textContent = '»';
    next.disabled = currentPage === totalPages;
    next.onclick = () => { if (currentPage < totalPages) { currentPage++; renderVideos(); } };
    paginationEl.appendChild(next);
}

function openVideo(video) {
    if (video.protected) {
        currentVideo = video;
        passwordModal.style.display = 'flex';
        videoPassword.value = '';
        passwordError.style.display = 'none';
        videoPassword.focus();
    } else {
        playInPopup(video);
    }
}
function playInPopup(video) {
    const url = getEmbedUrl(video);
    if (!url) { alert("Content not available."); return; }
    popupTitle.textContent = video.title;
    popupFrame.src = url;
    popupModal.style.display = 'flex';
}
function validatePassword() {
    if (videoPassword.value === VIDEO_PASSWORD) {
        passwordModal.style.display = 'none';
        if (currentVideo) { playInPopup(currentVideo); currentVideo = null; }
    } else {
        passwordError.style.display = 'block';
        setTimeout(() => passwordError.style.display = 'none', 2000);
    }
}

// Auth Logic
function openAuthModal() {
    authModal.style.display = 'flex';
    authError.style.display = 'none';
    authError.textContent = '';
    authEmail.value = '';
    authPassword.value = '';
    authEmail.focus();
}
function handleAuth(e) {
    e.preventDefault();
    const email = authEmail.value.trim();
    const password = authPassword.value;
    authError.style.display = 'none';
    authSubmitBtn.disabled = true;
    authSubmitBtn.textContent = 'Logging in...';
    signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => { authModal.style.display = 'none'; })
        .catch((error) => {
            authError.textContent = "Error: " + error.message;
            authError.style.display = 'block';
            authSubmitBtn.disabled = false;
            authSubmitBtn.textContent = 'Login';
        });
}
function handleLogout() {
    signOut(auth).then(() => { console.log("Logged out"); }).catch((error) => { console.error(error); });
}

// Admin Actions
adminBtn.addEventListener('click', () => {
    if (currentUser) {
        addVideoModal.style.display = 'flex';
        updateDataLists();
    }
});
cancelAddVideo.addEventListener('click', () => {
    addVideoModal.style.display = 'none';
    addVideoForm.reset();
    addVideoStatus.textContent = '';
});
addVideoForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!db || !currentUser) { alert("Not authenticated"); return; }
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "Saving...";
    addVideoStatus.textContent = "";
    const newVideo = {
        title: document.getElementById('newTitle').value,
        type: document.getElementById('newType').value,
        id: document.getElementById('newId').value,
        url: document.getElementById('newId').value,
        category: document.getElementById('newCategory').value,
        subcategory: document.getElementById('newSubcategory').value,
        topic: document.getElementById('newTopic').value,
        protected: document.getElementById('newProtected').checked,
        createdAt: new Date(),
        addedBy: currentUser.email
    };
    try {
        await addDoc(collection(db, "videos"), newVideo);
        addVideoStatus.textContent = "Video added successfully!";
        addVideoStatus.className = "status-success";
        addVideoForm.reset();
        setTimeout(() => { addVideoModal.style.display = 'none'; addVideoStatus.textContent = ""; }, 1500);
    } catch (error) {
        console.error("Error adding document: ", error);
        addVideoStatus.textContent = "Error: " + error.message;
        addVideoStatus.className = "status-error";
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
});

// Event Listeners
authBtn.addEventListener('click', () => { if (currentUser) { handleLogout(); } else { openAuthModal(); } });
authForm.addEventListener('submit', handleAuth);
cancelAuth.addEventListener('click', () => { authModal.style.display = 'none'; });

// ✅ FIXED: Filter event listeners with proper trim and refresh
categoryFilter.addEventListener('change', () => {
    updateSubcategories();
    updateTopics();
    applyFilters();
});
subcategoryFilter.addEventListener('change', () => {
    updateTopics();
    applyFilters();
});
topicFilter.addEventListener('change', () => {
    applyFilters();
});
searchBox.addEventListener('input', () => {
    applyFilters();
});
headerTitle.addEventListener('click', () => { 
    categoryFilter.value = ''; 
    subcategoryFilter.value = ''; 
    topicFilter.value = ''; 
    searchBox.value = ''; 
    updateSubcategories(); 
    updateTopics(); 
    applyFilters(); 
    popupModal.style.display = 'none'; 
    popupFrame.src = ''; 
});
closePopup.addEventListener('click', () => { popupModal.style.display = 'none'; popupFrame.src = ''; });
backToListBtn.addEventListener('click', () => { popupModal.style.display = 'none'; popupFrame.src = ''; });
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (passwordModal.style.display === 'flex') passwordModal.style.display = 'none';
        else if (popupModal.style.display === 'flex') { popupModal.style.display = 'none'; popupFrame.src = ''; }
        else if (addVideoModal.style.display === 'flex') addVideoModal.style.display = 'none';
        else if (authModal.style.display === 'flex') authModal.style.display = 'none';
    }
});
submitPassword.addEventListener('click', validatePassword);
videoPassword.addEventListener('keypress', (e) => { if (e.key === 'Enter') validatePassword(); });
cancelPassword.addEventListener('click', () => { passwordModal.style.display = 'none'; currentVideo = null; });
</script>
</body>
</html>
